---
- name: Prepare Bench
  hosts: all
  become: true
  tasks:
    - name: Sync app code
      ansible.builtin.copy:
        src: /contents/home/isucon/isuumo
        dest: /home/isucon/
        #owner: isucon
        #group: isucon
    - name: Sync nginx conf
      ansible.builtin.copy:
        src: /contents/etc/nginx
        dest: /etc/
    - name: Sync mysql conf
      ansible.builtin.copy:
        src: /contents/etc/mysql
        dest: /etc/
    - name: Build Go App
      ansible.builtin.shell:
        cmd: source ~/.bashrc && make all
        chdir: /home/isucon/isuumo/webapp/go
        executable: /bin/bash
      become: true
      become_user: isucon
    - name: Run sql/init.sh
      ansible.builtin.shell:
          cmd: source ~/.bashrc && ./init.sh
          chdir: /home/isucon/isuumo/webapp/mysql/db
          executable: /bin/bash
      become: true
      become_user: isucon
    # serviceの再起動はログのローテートが終わってから
    - name: Rotate nginx log
      ansible.builtin.copy:
        content: ''
        dest: "{{ item }}"
        backup: true
      loop:
        - /var/log/nginx/access.log
        - /var/log/nginx/error.log
    - name: Rotate mysql log files
      ansible.builtin.copy:
        content: ''
        dest: /var/log/mysql/mysql-slow.log
        backup: true
    - name: Restart systemd services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
        daemon_reload: true
        enabled: true
      loop:
        - isuumo.go
        - mysql
        - nginx
